<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Magic Christmas â€“ Stable</title>

  <!-- LIBS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; font-family:Segoe UI,sans-serif; }
    #canvas-container { width:100%; height:100vh; }
    #ui {
      position:absolute; bottom:30px; width:100%; text-align:center; z-index:10;
    }
    #ui button {
      padding:15px 50px; border-radius:30px; border:2px solid gold;
      background:linear-gradient(#d32f2f,#8b0000); color:#fff;
      font-weight:800; cursor:pointer;
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)} }
    #camera-preview {
      position:absolute; top:15px; right:15px;
      width:120px; height:90px; opacity:.6; transform:scaleX(-1);
      border:2px solid rgba(255,0,0,.5); border-radius:8px;
    }
  </style>
</head>
<body>

<div id="canvas-container"></div>

<div id="ui">
  <button onclick="start()">START MAGIC</button>
</div>

<video class="input_video" style="display:none"></video>
<canvas id="camera-preview"></canvas>

<script>
/* =======================
   BASIC THREE.JS SCENE
======================= */
let scene, camera, renderer, particles;
let state = "TREE"; // TREE | EXPLODE | HEART
let handX = 0.5;

function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
  camera.position.z = 80;

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  document.getElementById("canvas-container").appendChild(renderer.domElement);

  const geo = new THREE.BufferGeometry();
  const count = 1500;
  const pos = new Float32Array(count * 3);

  for (let i=0;i<count;i++){
    pos[i*3] = (Math.random()-0.5)*40;
    pos[i*3+1] = (Math.random()-0.5)*60;
    pos[i*3+2] = (Math.random()-0.5)*40;
  }
  geo.setAttribute("position", new THREE.BufferAttribute(pos,3));

  const mat = new THREE.PointsMaterial({
    color:0xffd700, size:1.5, transparent:true
  });

  particles = new THREE.Points(geo, mat);
  scene.add(particles);

  animate();
}

function animate(){
  requestAnimationFrame(animate);

  if(state === "TREE"){
    particles.rotation.y += 0.003;
  } else if(state === "EXPLODE"){
    particles.rotation.y += (handX-0.5)*0.05;
  } else if(state === "HEART"){
    particles.scale.setScalar(1 + Math.abs(Math.sin(Date.now()*0.003))*0.1);
  }

  renderer.render(scene,camera);
}

window.addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* =======================
   HAND TRACKING (SAFE)
======================= */
function start(){
  init3D();

  const video = document.querySelector(".input_video");
  const canvas = document.getElementById("camera-preview");
  canvas.width = 120; canvas.height = 90;
  const ctx = canvas.getContext("2d");

  const hands = new Hands({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
  });

  hands.onResults(res=>{
    ctx.clearRect(0,0,120,90);
    if(res.image) ctx.drawImage(res.image,0,0,120,90);

    // âœ… SAFE CHECK â€“ khÃ´ng crash
    if(res.multiHandLandmarks && res.multiHandLandmarks.length>0){
      const lm = res.multiHandLandmarks[0];
      handX = lm[9].x;

      const wrist = lm[0];
      const tips = [8,12,16,20];
      let open = 0;
      tips.forEach(i=>{
        open += Math.hypot(lm[i].x-wrist.x, lm[i].y-wrist.y);
      });
      open /= tips.length;

      if(open < 0.25){
        state = "TREE";        // âœŠ náº¯m
      } else if(open > 0.45){
        state = "EXPLODE";     // âœ‹ má»Ÿ
      } else {
        state = "HEART";       // ðŸ«¶ giá»¯a
      }
    } else {
      state = "TREE";
    }
  });

  const cam = new Camera(video,{
    onFrame: async()=>{ await hands.send({image:video}); },
    width:320, height:240
  });
  cam.start();
}
</script>
</body>
</html>
